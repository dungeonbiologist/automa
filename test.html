<html>
<head>
<meta charset="utf-8"/>
<script type="text/javascript" src="parse.js"></script>
<script type="text/javascript">
'use strict';
var differential = false;
var grabbed = null;
const states= 3;
const size = 10;
const colors=["#FF4444","#44FF44","#4444FF","#888888"];
var mouse = {x:0, y:0};
function main(){
	if (window.Event) {;
		document.captureEvents(Event.MOUSEMOVE);
		document.captureEvents(Event.MOUSEDOWN);
		document.captureEvents(Event.MOUSEUP);
		document.captureEvents(Event.INPUT);
		document.captureEvents(Event.KEYUP);
	}
	window.addEventListener('mouseup', mouseUp, false);
	window.addEventListener('mousemove', mouseMove, false);
	createSlider();
//	createSlider();
}
function createSlider(){
	var slider = document.createElement("div");
	slider.className="slider";
	document.body.appendChild(slider);
		var container = document.createElement("span");
		container.className="container";
		slider.appendChild(container);
			var line = document.createElement("div");
			line.className="line";
			container.appendChild(line);
			
		var value = document.createElement("div");
		value.className="value";
		value.textContent = "0";
		slider.appendChild(value);
		
		var clear = document.createElement("span");
		clear.className="clear";
		slider.appendChild(clear);
		
		var code = document.createElement("div");
		code.setAttribute("contentEditable",true);
		code.className="code1";
		code.textContent=" ";
		slider.appendChild(code);
	code.addEventListener('input', parseScript, false);
	clear.addEventListener('mousedown', deleteTarget, false);
	container.addEventListener('mousedown', addTarget, false);
}
function deleteTarget(e){
	var node = findChild(e.target.parentNode,"target");
	if(node){
		node.parentNode.removeChild(node);
	}
}
function addTarget(e){
	var already = findChild(e.target.parentNode,"target");
	if(!already){
		var node = document.createElement("span");
		node.setAttribute("contentEditable",true);
		node.className="target grabable";
		node.textContent="0";
		e.target.parentNode.appendChild(node);
		node.addEventListener('mousedown', grabNode, false);
		node.addEventListener('keyup', adjustPosition, false);
		differential = -getPosition(e.target.parentNode).x;
		node.style.left = mouse.x+differential + "px"
		grabbed = node;
		mouseMove(e);
	}
}
function grabNode(e){
	var x = e.target;
	if(x.classList.contains("grabable")){
		differential = (parseInt(x.style.left, 10)||0) - mouse.x;
		grabbed = x;
	}
}
function findChild(node,id){
	for(var i=0; i<node.children.length; i++){
		if(node.children[i].classList.contains(id)){
			return node.children[i];
		}
	}
	return null;
}
function adjustPosition(e){
	e.target.textContent = e.target.textContent.replace(/[^0-9.]/g,'')
	var value = parseFloat(e.target.textContent) || 0;
	e.target.style.left= clamp(0, value*200, 200) + "px";
}
function clamp(min,x,max){
	return Math.max(min,Math.min(x,max));
}

function mouseMove(e){
	if (window.Event) {
		mouse.x = e.pageX;
		mouse.y = e.pageY;
	} else {
		mouse.x = event.clientX + (document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft);
		mouse.y = event.clientY + (document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop);
	}
	if(differential !== false && grabbed){
		var x = grabbed;
		var value = clamp(0,differential + mouse.x, 200);
		var str = value + "px";
		x.textContent = value/200;
		x.style.left = str;
	}
}
function mouseUp(e){
	differential = false;
	grabbed = null;
}
function getPosition(el){
	var xPos = 0;
	var yPos = 0;
	while (el) {
		if (el.tagName == "BODY") {
			// deal with browser quirks with body/window/document and page scroll
			var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
			var yScroll = el.scrollTop || document.documentElement.scrollTop;
			xPos += (el.offsetLeft - xScroll + el.clientLeft);
			yPos += (el.offsetTop - yScroll + el.clientTop);
		} else {
			// for all other non-BODY elements
			xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
			yPos += (el.offsetTop - el.scrollTop + el.clientTop);
		}
		el = el.offsetParent;
	}
	return {
		x: xPos,
		y: yPos
	};
}
function zeroArray(length){
	var ar =[];
	for(var i=0; i<length; i++){
		ar[i]=0;
	}
	return ar;
}
function bit(n,num){
	return Math.floor(num / Math.pow(states,n))%states;
}
function illustrateRule(rule){
	var image = document.createElement('canvas');
	image.width  = size*2;
	image.height = size*2;
	var context = image.getContext('2d');
	context.fillStyle = colors[rule[0]];
	context.fillRect(0,0,size,size);
	context.fillStyle = colors[rule[1]];
	context.fillRect(size,0,size,size);
	context.fillStyle = colors[rule[2]];
	context.fillRect(size/2,size,size,size);
	return image;
}
</script>
<link rel="stylesheet" href="automa.css">
</head>
<body onload="main();">
	<span id="output"></span>
</body>
</html>
